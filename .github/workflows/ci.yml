name: CI

on:
  push:
    branches: [main, development]
  pull_request:
    branches: [main, development]

jobs:
  backend-build:
    name: Build Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21
      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('backend/gradlew') }}
      - run: chmod +x ./backend/gradlew
      - run: ./gradlew build --no-daemon
        working-directory: backend
      - name: Upload Backend Jar
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: backend/build/libs/*.jar

  backend-tests:
    name: Test Backend
    runs-on: ubuntu-latest
    needs: backend-build
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21
      - run: chmod +x ./backend/gradlew
      - run: ./gradlew test --no-daemon
        working-directory: backend

  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    needs: backend-build
    strategy:
      matrix:
        node-version: [22, 24]
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - name: Cache Node modules
        uses: actions/cache@v3
        with:
          path: frontend/node_modules
          key: node-${{ matrix.node-version }}-${{ hashFiles('frontend/package-lock.json') }}
      - run: npm ci
        working-directory: frontend
      - run: npm run lint
        working-directory: frontend
      - run: npm run build
        working-directory: frontend
      - name: Upload Frontend Dist
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist-node-${{ matrix.node-version }}
          path: frontend/dist

  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    needs: frontend-build
    strategy:
      matrix:
        node-version: [22, 24]
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - run: npm ci
        working-directory: frontend
      - run: npm run --if-present test
        working-directory: frontend
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs:
      - backend-build
      - frontend-build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || (github.event_name == 'pull_request' && contains(join(fromJSON(toJson(github.event.pull_request.labels)), ','), 'run-integration'))
    steps:
      - uses: actions/checkout@v3

      - name: Download Backend Jar
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: ./backend-artifact

      - name: Download Frontend Dist Node 22
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist-node-22
          path: ./frontend-artifact/node22

      - name: Download Frontend Dist Node 24
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist-node-24
          path: ./frontend-artifact/node24

      - name: Start MariaDB
        run: docker compose -f ./docker-compose.test.yml up -d

      - name: Wait for DB
        run: |
          until docker exec mariadb mysqladmin ping -h"localhost" --silent; do
            echo "Waiting for DB..."
            sleep 2
          done

      - name: Run Backend
        run: java -jar ./backend-artifact/*.jar &

      - run: sleep 5 # wait for the backend to start

      - name: Run Integration Tests
        run: ./backend/gradlew integrationTest --no-daemon
        working-directory: backend
  create-pre-release:
    name: Create Pre-release
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [backend-build, frontend-build]
    steps:
      - uses: actions/checkout@v3

      - name: Get commit log
        id: commits
        run: |
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          git log --pretty=format:"%h %s" ${{ github.event.before }}..${{ github.sha }} >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create pre-release
        uses: actions/create-release@v1
        with:
          tag_name: pre-${{ github.run_number }}
          release_name: Pre-release ${{ github.run_number }}
          body: ${{ steps.commits.outputs.commits }}
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
